<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledgebase - PKM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #2563eb; --bg: #ffffff; --sidebar: #f8fafc; 
            --border: #e2e8f0; --text: #1e293b; --item-hover: #f1f5f9;
        }
        [data-theme="dark"] {
            --primary: #3b82f6; --bg: #0f172a; --sidebar: #1e293b; 
            --border: #334155; --text: #f1f5f9; --item-hover: #334155;
        }
        body { font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 260px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .branding { font-weight: 700; letter-spacing: -0.5px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        #search-input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 0.85rem; }
        .btn-new { background: var(--primary); color: white; border: none; padding: 10px; width: 100%; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px; }

        #note-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .folder-section { margin-bottom: 10px; }
        .folder-label { padding: 8px 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #64748b; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .note-item { padding: 8px 20px 8px 35px; cursor: pointer; font-size: 0.9rem; border-left: 3px solid transparent; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-item:hover { background: var(--item-hover); }
        .note-item.active { background: var(--item-hover); border-left-color: var(--primary); font-weight: 600; }

        /* Main */
        #main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #editor-container { flex: 1; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
        .editor-width { width: 100%; max-width: 850px; padding: 40px 25px; }
        
        #note-title { font-size: 2.5rem; font-weight: 800; border: none; outline: none; background: transparent; color: var(--text); width: 100%; margin-bottom: 10px; }
        .meta-bar { display: flex; gap: 15px; font-size: 0.8rem; margin-bottom: 20px; opacity: 0.7; align-items: center; }

        .toolbar { 
            display: flex; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); 
            position: sticky; top: 0; background: var(--bg); z-index: 10; margin-bottom: 20px; align-items: center;
        }

        /* PKM Editor Content */
        #editor { flex: 1; min-height: 600px; outline: none; line-height: 1.6; font-size: 1.1rem; }
        
        /* Table Styling */
        table { border-collapse: collapse; width: 100%; margin: 20px 0; border: 1px solid var(--border); }
        th, td { border: 1px solid var(--border); padding: 12px; text-align: left; min-width: 80px; }
        th { background: var(--sidebar); font-weight: 600; }

        button, select { padding: 6px 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text); border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
        .btn-table { border: 2px solid var(--primary); font-weight: 700; background: #eff6ff; color: var(--primary); }
        [data-theme="dark"] .btn-table { background: #1e293b; }

        .status-bar { padding: 8px 25px; font-size: 0.75rem; background: var(--sidebar); border-top: 1px solid var(--border); display: flex; gap: 20px; }
    </style>
</head>
<body data-theme="light">

<div id="sidebar">
    <div class="sidebar-header">
        <div class="branding">KNOWLEDGEBASE <span onclick="toggleTheme()" style="cursor:pointer">ðŸŒ“</span></div>
        <input type="text" id="search-input" placeholder="Search entries..." oninput="renderList()">
        <button class="btn-new" onclick="newNote()">+ New Entry</button>
    </div>
    <div id="note-list"></div>
</div>

<div id="main">
    <div id="editor-container">
        <div class="editor-width">
            <input type="text" id="note-title" placeholder="Untitled">
            <div class="meta-bar">
                Folder: <select id="note-folder" onchange="save()"></select>
                <span id="save-indicator">Saved</span>
            </div>
            
            <div class="toolbar">
                <button class="btn-table" onclick="insertTable()">+ Insert Table</button>
                <button onclick="exec('bold')"><b>B</b></button>
                <button onclick="exec('italic')"><i>I</i></button>
                <button onclick="insertCheckbox()">â˜‘ Task</button>
                <button onclick="exec('insertUnorderedList')">â€¢ List</button>
                <select id="font-family" onchange="updateStyleAttr()">
                    <option value="font-inter">Sans</option>
                    <option value="font-jetbrains">Mono</option>
                </select>
                <button onclick="deleteNote()" style="margin-left:auto; color:#ef4444; border:none;">Delete</button>
            </div>

            <div id="editor" contenteditable="true" oninput="save()"></div>
        </div>
    </div>
    <div class="status-bar">
        <span id="word-count">0 words</span>
    </div>
</div>

<script>
    let notes = JSON.parse(localStorage.getItem('pkm_notes_v9')) || [];
    let folders = JSON.parse(localStorage.getItem('pkm_folders_v9')) || ["General", "Projects", "Resources"];
    let currentId = null;

    function exec(cmd) { document.execCommand(cmd, false, null); save(); }

    function insertTable() {
        const rows = prompt("Number of rows:", "3");
        const cols = prompt("Number of columns:", "2");
        if (!rows || !cols) return;

        let tableHtml = "<table><thead><tr>";
        for (let j = 0; j < cols; j++) tableHtml += "<th>Header</th>";
        tableHtml += "</tr></thead><tbody>";
        for (let i = 0; i < rows; i++) {
            tableHtml += "<tr>";
            for (let j = 0; j < cols; j++) tableHtml += "<td>Data</td>";
            tableHtml += "</tr>";
        }
        tableHtml += "</tbody></table><p><br></p>";
        document.execCommand('insertHTML', false, tableHtml);
        save();
    }

    function insertCheckbox() {
        const html = `<div style="display:flex; gap:10px; margin:5px 0;" contenteditable="false"><input type="checkbox"> <span contenteditable="true" style="outline:none">Task item</span></div>`;
        document.execCommand('insertHTML', false, html);
        save();
    }

    function save() {
        if (!currentId) return;
        const note = notes.find(n => n.id === currentId);
        if (note) {
            note.title = document.getElementById('note-title').value || 'Untitled';
            note.folder = document.getElementById('note-folder').value;
            note.content = document.getElementById('editor').innerHTML;
            note.updated = Date.now();
        }
        localStorage.setItem('pkm_notes_v9', JSON.stringify(notes));
        updateWordCount();
        renderList();
        
        const indicator = document.getElementById('save-indicator');
        indicator.innerText = "Saving...";
        setTimeout(() => indicator.innerText = "Saved", 500);
    }

    function updateWordCount() {
        const text = document.getElementById('editor').innerText || "";
        const count = text.trim() ? text.trim().split(/\s+/).length : 0;
        document.getElementById('word-count').textContent = `${count} words`;
    }

    function renderList() {
        const list = document.getElementById('note-list');
        const search = document.getElementById('search-input').value.toLowerCase();
        list.innerHTML = '';

        folders.forEach(f => {
            const folderNotes = notes.filter(n => n.folder === f && n.title.toLowerCase().includes(search));
            const div = document.createElement('div');
            div.className = 'folder-section';
            div.innerHTML = `<div class="folder-label">â–¼ ${f}</div>`;
            
            folderNotes.forEach(n => {
                const item = document.createElement('div');
                item.className = `note-item ${n.id === currentId ? 'active' : ''}`;
                item.textContent = n.title;
                item.onclick = () => loadNote(n.id);
                div.appendChild(item);
            });
            list.appendChild(div);
        });
    }

    function loadNote(id) {
        currentId = id;
        const note = notes.find(n => n.id === id);
        renderFolderOptions();
        document.getElementById('note-title').value = note.title;
        document.getElementById('note-folder').value = note.folder;
        document.getElementById('editor').innerHTML = note.content;
        updateWordCount();
        renderList();
    }

    function newNote() {
        const id = Date.now();
        notes.unshift({ id, title: 'New Entry', folder: folders[0], content: '', updated: id });
        loadNote(id);
    }

    function deleteNote() {
        if (confirm("Permanently delete this entry?")) {
            notes = notes.filter(n => n.id !== currentId);
            if (notes.length) loadNote(notes[0].id); else newNote();
        }
    }

    function renderFolderOptions() {
        document.getElementById('note-folder').innerHTML = folders.map(f => `<option value="${f}">${f}</option>`).join('');
    }

    function toggleTheme() {
        const body = document.body;
        const theme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        body.setAttribute('data-theme', theme);
    }

    function updateStyleAttr() {
        const font = document.getElementById('font-family').value;
        document.getElementById('editor').style.fontFamily = font === 'font-inter' ? 'Inter' : 'JetBrains Mono';
        save();
    }

    document.getElementById('note-title').addEventListener('input', save);
    renderFolderOptions();
    if (notes.length) loadNote(notes[0].id); else newNote();
</script>
</body>
</html>
